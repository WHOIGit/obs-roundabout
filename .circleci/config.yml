version: 2

workflows:
  version: 2
  test:
    jobs:
      - build

jobs:
  build:

    # If you want to run in a virtual machine, switch to the `machine` executor,
    # and remove the `setup_remote_docker` step.
    #   machine: true
    #   docker_layer_caching: true
    docker:
      - image: docker:18.06.0-ce

    steps:
      - checkout
      - run:
          # The container image we use is Alpine-based, and we cannot run the
          # docker-compose binary releases on Alpine. Build it ourselves.
          name: Installing Docker Compose
          command: >-
            apk add --update \
              build-base \
              libffi-dev \
              openssl-dev \
              python \
              python-dev \
              py-pip &&
            pip install --upgrade pip &&
            pip install docker-compose
      - setup_remote_docker:
          docker_layer_caching: true
          version: 18.06.0-ce
      - run:
          name: Building Docker application
          command: >-
            mv .envs.example .envs &&
            docker-compose --file local.yml build
      - run:
          # The Django start script will run migrations for us
          name: Starting Docker application
          command: >-
            docker-compose --file local.yml up
      - run:
          name: Checking for missing migrations
          command: >-
            docker-compose --file local.yml run --rm django \
              python manage.py makemigrations --check
      - run:
          name: Running Django system checks
          command: >-
            docker-compose --file local.yml run --rm django \
              python manage.py check
      - run:
          name: Running Django tests
          command: >-
            docker-compose --file local.yml run --rm django \
              python manage.py test
      - run:
          name: Stopping Docker application
          command: >-
            docker-compose --file local.yml down
