<!--
# Copyright (C) 2019-2020 Woods Hole Oceanographic Institution
#
# This file is part of the Roundabout Database project ("RDB" or
# "ooicgsn-roundabout").
#
# ooicgsn-roundabout is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# ooicgsn-roundabout is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with ooicgsn-roundabout in the COPYING.md file at the project root.
# If not, see <http://www.gnu.org/licenses/>.
-->
{% load common_tags %}

<div class="tab-pane fade" id="calibration-template" role="tabpanel" aria-labelledby="calibration-template-tab">
    <ul class="list-group">
        {% for event in inventory_item.inventory_calibrationevents.all %}
            <li class="list-group-item">
                <a  class="collapsed"
                    data-toggle="collapse"
                    href="#event-{{ event.id }}"
                    aria-expanded="false"
                    aria-controls="event-{{ event.id }}"
                >
                    {{ event.calibration_date|date:"n/j/y" }}
                </a>
                <a  data-toggle="collapse"
                    class="collapsed text-right"
                    href="#event-{{ event.id }}"
                    aria-controls="event-{{ event.id }}"
                    aria-expanded="false"
                    role="button"
                    id = 'badge_tag'
                >
                    <i class="fa" aria-hidden="true"></i>
                    <span class="sr-only">Expand/Collapse Calibration {{ event.calibration_date }}</span>
                </a>
                {% if user in event.user_draft.all %}
                    <span id="review-badge" class="badge badge-pill badge-secondary">Review Requested</span>
                {% endif %}
                {% if event.approved %}
                    <span id="approve-badge" class="badge badge-pill badge-success">Approved</span>
                {% else %}
                    <span id="progress-badge" class="badge badge-pill badge-info">In Progress</span>
                {% endif %}
                {% if not user|has_group:"inventory only" %}
                    <div class = 'ajax-detail-link float-right'>
                        <a  href="#"
                            class="btn btn-primary btn-sm mr-2"
                            role="button"
                            data-detail-url="{% url 'calibrations:event_valueset_update' event.id %}"
                            data-node-id="{{ event.id }}"
                            data-node-type="{{ event.get_object_type }}">
                                Edit Coefficient Values
                        </a>
                    </div>
                {% endif %}
                <div class="collapse mt-3" id="event-{{ event.id }}">
                    <hr>
                    {% if user in event.user_draft.all %}
                        <button class="btn btn-success btn-sm mr-2" id='cal_expander-date-{{event.id}}' data-reviewer-url="{% url 'calibrations:event_review_toggle' event.id user.id event.get_object_type %}">
                            Approve
                        </button>
                    {% elif user in event.user_approver.all %}
                        <button class="btn btn-warning btn-sm mr-2" id='cal_expander-date-{{event.id}}' data-reviewer-url="{% url 'calibrations:event_review_toggle' event.id user.id event.get_object_type %}">
                            Unapprove
                        </button>
                    {% endif %}
                    {% if not user|has_group:"inventory only" %}
                        <div class="ajax-detail-link float-right">
                            <a  href="#"
                                class="btn btn-danger btn-sm mr-2"
                                data-detail-url="{% url 'calibrations:event_valueset_delete' event.id %}"
                                role="button"
                            >
                                    Delete
                            </a>
                        </div>
                    {% endif %}
                    <p id = 'approvers'>Approvers:
                        {% for user in event.get_sorted_approvers.all %}
                            <span id='approver-{{ user.id }}'>{{ user.username }}</span>
                        {% endfor %}
                    </p>
                    <p id = 'reviewers'>Reviewers:
                        {% for user in event.get_sorted_reviewers.all %}
                            <span id='reviewer-{{ user.id }}'>{{ user.username }}</span>
                        {% endfor %}
                    </p>

                  {# TABS PER EVENT #}
                    <ul class="nav nav-tabs" id="inventory-tabs-nav" role="tablist">
                        <li class="nav-item">
                            <a  class="nav-link active"
                                id="coefficients-{{ event.id }}-tab"
                                data-toggle="tab"
                                href="#coefficients-{{ event.id }}"
                                role="tab"
                                aria-controls="coefficients"
                                aria-selected="false">
                                    Coefficients
                            </a>
                        </li>
                        <li class="nav-item">
                            <a  class="nav-link"
                                id="eventhistory-{{ event.id }}-tab"
                                data-toggle="tab"
                                href="#eventhistory-{{ event.id }}"
                                role="tab"
                                aria-controls="eventhistory"
                                aria-selected="false">
                                    Event History
                            </a>
                        </li>
                        {% if event.hyperlinks.exists %}
                        <li class="nav-item">
                            <a  class="nav-link"
                                id="links-{{ event.id }}-tab"
                                data-toggle="tab"
                                href="#links-{{ event.id }}"
                                role="tab"
                                aria-controls="links"
                                aria-selected="false">
                                    Links
                            </a>
                        </li>
                        {% endif %}
                    </ul>

                    <div class="tab-content" id="inventory-tabs">
                        {% if event.coefficient_value_sets.all %}
                            {# EVENT COEFFICIENTS TAB #}
                            <div class="tab-pane fade show active" id="coefficients-{{ event.id }}" role="tabpanel" aria-labelledby="coefficients-{{ event.id }}-tab">
                                <table class="table table-tight">
                                    <tbody>
                                        {% for value_set in event.coefficient_value_sets.all %}
                                            <tr>
                                                <td>
                                                    <a  class="collapse show"
                                                        data-toggle="collapse"
                                                        href="#coeff-{{ value_set.coefficient_name }}{{ event.id }}"
                                                        aria-expanded="false"
                                                        aria-controls="coeff-{{ value_set.coefficient_name }}{{ event.id }}"
                                                    >
                                                        <b>{{ value_set.coefficient_name }}</b>
                                                    </a>
                                                    <a  data-toggle="collapse"
                                                        class="collapse show text-right"
                                                        href="#coeff-{{ value_set.coefficient_name }}{{ event.id }}"
                                                        aria-controls="coeff-{{ value_set.coefficient_name }}{{ event.id }}"
                                                        aria-expanded="false"
                                                        role="button"
                                                    >
                                                        <i class="fa" aria-hidden="true"></i>
                                                        <span class="sr-only">Expand/Collapse Calibration {{ value_set.coefficient_name }}</span>
                                                    </a>
                                                    {% if value_set.coefficient_name.value_set_type != '2d' %}
                                                        <div class = 'ajax-detail-link float-right'>
                                                            <a  href="#"
                                                                class="btn btn-primary btn-sm mr-2"
                                                                role="button"
                                                                data-detail-url="{% url 'calibrations:valueset_value_update' value_set.id 'none' %}"
                                                                data-node-id="{{ inventory_item.id }}"
                                                                data-node-type="inventory">
                                                                    Edit Coefficient Metadata
                                                            </a>
                                                        </div>
                                                    {% else %}
                                                        <div class = 'ajax-detail-link float-right'>
                                                            <a  href="#"
                                                                class="btn btn-primary btn-sm mr-2"
                                                                role="button"
                                                                data-detail-url="{% url 'calibrations:valueset_value_update' value_set.id 'none' %}"
                                                                data-node-id="{{ inventory_item.id }}"
                                                                data-node-type="inventory"
                                                                id = '2d-coeff-edit-{{ value_set.id }}'>
                                                                    Edit Coefficient Metadata
                                                            </a>
                                                        </div>
                                                    {% endif %}

                                                    {# COLLAPSING EVENT VALUE AREA #}
                                                    <div class="collapse show mt-1 border p-2 m-3" id="coeff-{{ value_set.coefficient_name }}{{ event.id }}">
                                                        <p class='font-weight-light'><b>Notes:</b> {{ value_set.notes }}</p>
                                                        <table id = 'coeff-val-table' class="table table-tight">
                                                            <thead>
                                                                <th>Value(s)</th>
                                                            </thead>
                                                            <tbody class = 'coeff-tbody' id = 'coeff-val-tbody' style = 'display:block; overflow: auto; max-height: 200px'>
                                                                {% regroup value_set.coefficient_values.all by row as row_sets %}
                                                                {% for row in row_sets %}
                                                                    <tr style = 'display: block;'>
                                                                        {% for val in row.list %}
                                                                            <td style = 'white-space: nowrap'>
                                                                                <div data-val-id = '{{val.id}}' id = 'coeff_val-{{ val.id }}' style = 'width: 100px; text-align: center;'>{{ val }}</div>
                                                                            </td>
                                                                        {% endfor %}
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}

                        {# EVENT HISTORY TAB #}
                        <div class="tab-pane fade border m-2 p-2" id="eventhistory-{{ event.id }}" role="tabpanel" aria-labelledby="eventhistory-{{ event.id }}-tab">
                            <table class="table table-tight table-striped action-table">
                                <thead>
                                    <th>Date</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>Person</th>
                                </thead>
                                <tbody style = 'overflow: auto; max-height: 200px'>
                                    {% for action in event.get_actions.all %}
                                        <tr>
                                            <td>{{ action.created_at|date:"n/j/y H:i" }}</td>
                                            <td>{{ action.get_action_type_display }}</td>
                                            <td>
                                                {{ action.detail|safe }}
                                            </td>
                                            <td>{{ action.user.username }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {# LINKS TAB #}
                        {% if event.hyperlinks.exists %}
                        <div class="tab-pane fade m-2 p-2" id="links-{{ event.id }}" role="tabpanel" aria-labelledby="links-{{ event.id }}-tab">
                          <ul>
                            {% for link in event.hyperlinks.all %}
                              <li><a target="_blank" href="{{ link.url }}">{{ link.text }} <i class="fas fa-link"></i></a></li>
                            {% endfor %}
                          </ul>
                        </div>
                        {% endif %}

                    </div> {# end of collapsing section #}
                </div>
            </li>
        {% endfor %}
    </ul>
</div>

{% block javascript %}
<script>
    $(document).ready(function() {

        // Toggle display of Calibration and Configuration Actions section
        let user_id = '{{ user.id }}'
        let inv_part_type = '{{ inventory_item.part.part_type }}';
        let part_has_cals = '{{ inventory_item.part.part_coefficientnameevents.exists }}';
        let inv_id = '{{ inventory_item.id }}';

        setCoeffTableWidth();
        $( window ).bind( "resize", setCoeffTableWidth );

        // Auto-resize CoefficientValue tables for horizontal scrolling
        function setCoeffTableWidth() {
            let invTabWidth =  $('#inventory-tabs').width();
            let tBodyWidth = invTabWidth - (invTabWidth * .1);
            $('.coeff-tbody').each(function() {
                $(this).css('max-width', tBodyWidth + 'px' );
            })
        }

        handleReviewBadges('#calibration-template', 'button[id^=cal_expander]', '{{ user.id }}', '{{ user.username }}', inv_id)


        $('[id^=2d-coeff-edit]').hide();

        let selected_coeff_val_id_array = []

        // Toggle coefficient_value selection
        $('#calibration-template').on('click', 'div[id^=coeff_val]', function(e) {
            e.preventDefault();
            let val = $(this);
            let coeff_tbody = val.parent().parent().parent().parent().find('[id$=tbody]');
            let coeff_edit_btn = val.parent().parent().parent().parent().parent().parent().find('[id^=2d-coeff-edit]');
            if (coeff_edit_btn.length) {
                if (val.css('background-color') == 'rgb(255, 255, 0)') {
                    val.css('background-color', '');
                    let val_id = val.data('val-id')
                    selected_coeff_val_id_array = selected_coeff_val_id_array.filter(val => val !== val_id)
                } else {
                    val.css('background-color', 'yellow')
                    selected_coeff_val_id_array.push(val.data('val-id'))
                }
            }
            let coeff_vals_selected = coeff_tbody.find('div[id^=coeff_val]').filter(function() {
                let coeff_val = $(this);
                let coeff_bkgrnd_clor = coeff_val.css('background-color')
                return coeff_bkgrnd_clor === 'rgb(255, 255, 0)'
            });
            if (coeff_vals_selected.length) {
                coeff_edit_btn.show()
            } else {
                coeff_edit_btn.hide()
            }
        });

        // Append sorted coefficient_value id array to metadata-edit url route
        $('#inventory-tabs').on('click', 'a[id^=2d-coeff-edit]', function(e) {
            e.preventDefault();
            selected_coeff_val_id_array = selected_coeff_val_id_array.sort(function(a,b) {
                return a - b
            });
            let edit_btn = $(this);
            let url = edit_btn.attr('data-detail-url');
            url = url.replace('none', selected_coeff_val_id_array.join())
            edit_btn.attr('data-detail-url', url);
        });
    });
</script>
{% endblock javascript %}
