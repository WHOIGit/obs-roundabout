<!--
# Copyright (C) 2019-2020 Woods Hole Oceanographic Institution
#
# This file is part of the Roundabout Database project ("RDB" or
# "ooicgsn-roundabout").
#
# ooicgsn-roundabout is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# ooicgsn-roundabout is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with ooicgsn-roundabout in the COPYING.md file at the project root.
# If not, see <http://www.gnu.org/licenses/>.
-->
{% load common_tags %}

<div class="tab-pane fade" id="conf_const-template" role="tabpanel" aria-labelledby="conf_const-template-tab">
    <ul class="list-group">
        {% for event in inventory_item.config_events.all %}
            <li class="list-group-item">
                <a  class="collapsed" 
                    data-toggle="collapse" 
                    href="#conf_event-{{ event.id }}" 
                    aria-expanded="false" 
                    aria-controls="conf_event-{{ event.id }}"
                >
                    {% if event.deployment.get_deployment_status_label == 'Deployed' %}
                        {{ event.get_latest_deployment_date|date:"n/j/y" }}
                    {% else %}
                        TBD
                    {% endif %}
                    -- {{ event.deployment }} ({{ event.deployment.get_deployment_status_label }})
                </a>
                <a  data-toggle="collapse" 
                    class="collapsed text-right" 
                    href="#conf_event-{{ event.id }}" 
                    aria-controls="conf_event-{{ event.id }}" 
                    aria-expanded="false" 
                    role="button"
                >
                    <i class="fa" aria-hidden="true"></i>
                    <span class="sr-only">Expand/Collapse Configurations/Constants {{ event.configuration_date }}</span>
                </a>
                <div class = 'ajax-detail-link float-right'>
                    <a  href="#"
                        class="btn btn-primary btn-sm mr-2"
                        role="button"
                        data-detail-url="{% url 'configs_constants:config_event_value_update' event.id %}"
                        data-node-id="{{ event.id }}"
                        data-node-type="{{ event.get_object_type }}">
                            Edit Values
                    </a>
                </div>
                <div class="collapse mt-3" id="conf_event-{{ event.id }}">
                    <hr>
                    <div class="ajax-detail-link float-right">
                        <a  href="#" 
                            class="btn btn-danger btn-sm mr-2"
                            data-detail-url="{% url 'configs_constants:config_event_value_delete' event.id %}" 
                            role="button" 
                        >
                                Delete
                        </a>
                    </div>
                    <p>Approved: {{ event.approved }}</p>
                    <p>Approved by: {{ event.user_approver.username }}</p>
                    <p>Last Updated by: {{ event.user_draft.username }}</p>
                    <ul class="nav nav-tabs" id="inventory-tabs-nav" role="tablist">
                        <li class="nav-item">
                            <a  class="nav-link active" 
                                id="documentation-tab" 
                                data-toggle="tab" 
                                href="#configs_constants" 
                                role="tab" 
                                aria-controls="configs_constants" 
                                aria-selected="false">
                                    Configurations / Constants
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content" id="inventory-tabs">
                        {% if event.config_values.all %}
                            <div class="tab-pane fade show active" id="configs_constants" role="tabpanel" aria-labelledby="configs_constants-tab">
                                <table class="table table-tight">
                                    <thead>
                                        <th>Name</th>
                                    </thead>
                                    <tbody>
                                        {% for value_set in event.config_values.all %}
                                            <tr>
                                                <td> 
                                                    <li class = 'list-group-item'>
                                                        <a  class="collapse show" 
                                                            data-toggle="collapse" 
                                                            href="#conf_const-{{ value_set.config_name }}{{ event.id }}" 
                                                            aria-expanded="false" 
                                                            aria-controls="conf_const-{{ value_set.config_name }}{{ event.id }}"
                                                        >
                                                            <b>{{ value_set.config_name }}</b>
                                                        </a>
                                                        <a  data-toggle="collapse" 
                                                            class="collapse show text-right" 
                                                            href="#conf_const-{{ value_set.config_name }}{{ event.id }}" 
                                                            aria-controls="conf_const-{{ value_set.config_name }}{{ event.id }}" 
                                                            aria-expanded="false" 
                                                            role="button"
                                                        >
                                                            <i class="fa" aria-hidden="true"></i>
                                                            <span class="sr-only">Expand/Collapse Configuration {{ value_set.config_name }}</span>
                                                        </a>
                                                        <div class="collapse show mt-1" id="conf_const-{{ value_set.config_name }}{{ event.id }}">
                                                            <p class='font-weight-light'><b>Notes:</b> {{ value_set.notes }}</p>
                                                            <table id = 'conf_const-val-table' class="table table-tight">
                                                                <thead>
                                                                    <th>Value(s)</th>
                                                                </thead>
                                                                <tbody class = 'conf_const-tbody' id = 'conf_const-val-tbody' style = 'display:block; overflow: auto; max-height: 200px'>
                                                                    <tr style = 'display: block;'>
                                                                        <td style = 'white-space: nowrap'>{{ value_set.config_value }}</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </li>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </li>
        {% endfor %}
    </ul>
</div>


{% block javascript %}
<script>
    $(document).ready(function(){

        // Toggle display of Calibration and Configuration Actions sections
        let inv_part_type = '{{ inventory_item.part.part_type }}';
        let deployment = '{{ inventory_item.build.current_deployment }}';

        if (inv_part_type == 'Instrument' && deployment != 'None' && deployment.length > 0) {
            $('#add_conf_const_action').show();
            $('#conf_const-template-tab').show().css('display', '');
            $('#conf_const-template').show().css('display', '');
        } else {
            $('#add_conf_const_action').hide();
            $('#conf_const-template-tab').hide();
            $('#conf_const-template').hide();
        }
    });
</script>
{% endblock javascript %}