<!--
# Copyright (C) 2019-2020 Woods Hole Oceanographic Institution
#
# This file is part of the Roundabout Database project ("RDB" or
# "ooicgsn-roundabout").
#
# ooicgsn-roundabout is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# ooicgsn-roundabout is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with ooicgsn-roundabout in the COPYING.md file at the project root.
# If not, see <http://www.gnu.org/licenses/>.
-->
{% load static i18n %}
{% load common_tags %}
{% load inventory_tags %}

{% get_deployment_data inventory_item deployment_event as deployment_data %}
{% define deployment_data|get_item:'deployment_burnin_event' as deployment_burnin_event %}
{% define deployment_data|get_item:'deployment_to_sea_event' as deployment_to_sea_event %}
{% define deployment_data|get_item:'deployment_recovery_event' as deployment_recovery_event %}
{% define deployment_data|get_item:'deployment_retire_event' as deployment_retire_event %}

<a class="collapsed" data-toggle="collapse" href="#deployment-{{ deployment_event.id }}" aria-expanded="false" aria-controls="deployment-{{ deployment_event.id }}">
    {{ deployment_event.build.build_number }} - {{ label_deployments_app_singular }}: {{ deployment_event.deployment }}
</a>

<a data-toggle="collapse" class="collapsed text-right" href="#deployment-{{ deployment_event.id }}" aria-controls="deployment-{{ deployment_event.id }}" aria-expanded="false" role="button">
    <i class="fa" aria-hidden="true"></i>
    <span class="sr-only">Expand/Collapse Revision {{ deployment }}</span>
</a>

<div class="progress" style="height: 20px;">
    <div class="progress-bar {{ deployment_data|get_item:'bar_class' }}" role="progressbar" style="width: {{ deployment_data|get_item:'bar_width' }}%;" aria-valuenow="{{ deployment_data|get_item:'bar_width' }}" aria-valuemin="0" aria-valuemax="100">
        <span>{{ deployment_data|get_item:'status_label' }}</span>
    </div>
</div>

<div class="collapse mt-3" id="deployment-{{ deployment_event.id }}">

    <p>Build:
        <a href="{% url 'builds:builds_detail' deployment_event.build.id %}">{{ deployment_event.build }}</a>
    </p>

    <p>{{ label_deployments_app_singular }} Location: {{ deployment_event.location }}</p>

    <p>Current Build Deployment Status<br>
        <div class="progress" style="height: 20px;">
            <div class="progress-bar {{ deployment_event.deployment.get_deployment_progress_bar|get_item:'bar_class' }}" role="progressbar" style="width: {{ deployment_event.deployment.get_deployment_progress_bar|get_item:'bar_width' }}%;" aria-valuenow="{{ deployment_event.deployment.get_deployment_progress_bar|get_item:'bar_width' }}" aria-valuemin="0" aria-valuemax="100">
                <span>{{ deployment_event.deployment.get_deployment_status_label }}</span>
            </div>
        </div>
    </p>

    {% if deployment_event.deployment.get_deploytosea_details %}
        <p>{{ label_deployments_app_singular }} Date: {{ deployment_event.deployment.get_deploytosea_details|get_item:'deploy_date' }}</p>
    {% endif %}

    {% if deployment_to_sea_event.cruise %}
        <p>Cruise Deployed On:
            <a href="{% url 'cruises:cruises_detail' deployment_to_sea_event.cruise.id %}">{{ deployment_to_sea_event.cruise }}</a>
        </p>
    {% endif %}

    {% if deployment_recovery_event.cruise %}
        <p>Cruise Recovered On:
            <a href="{% url 'cruises:cruises_detail' deployment_recovery_event.cruise.id %}">{{ deployment_recovery_event.cruise }}</a>
        </p>
    {% endif %}



    {% if deployment_to_sea_event %}
    <h5>Item's Time on Deployment vs. Total {{ label_builds_app_singular }} Deployment</h5>
    <hr>
    <p>Time in Field: {{ deployment_data|get_item:'time_at_sea'|time_at_sea_display }}</p>
    {% if deployment_event.deployment.get_deployment_time_at_sea %}
        <p>Total Deployment Time in Field: {{ deployment_event.deployment.get_deployment_time_at_sea|time_at_sea_display }}</p>
    {% endif %}

	    <div id="deployment-percent-{{ deployment_event.id }}"></div>



    {% endif %}

    <table class="table table-striped action-table">
        <thead>
          <th>Date</th>
          <th>Action</th>
          <th>Details</th>
          <th>Person</th>
          <th>Location</th>

        </thead>
        <tbody>
            <tr>
                <td>{{ deployment_event.created_at|date:"n/j/y H:i" }}</td>
                <td>{{ deployment_event.get_action_type_display }}</td>
                <td>
                    {{ deployment_event.detail|safe }}
                </td>
                <td>{{ deployment_event.user.username }}</td>
                <td>{{ deployment_event.location.name }}</td>
            </tr>
            {% if deployment_burnin_event %}
                <tr>
                    <td>{{ deployment_burnin_event.created_at|date:"n/j/y H:i" }}</td>
                    <td>{{ deployment_burnin_event.get_action_type_display }}</td>
                    <td>
                        {{ deployment_burnin_event.detail|safe }}
                    </td>
                    <td>{{ deployment_burnin_event.user.username }}</td>
                    <td>{{ deployment_burnin_event.location.name }}</td>
                </tr>
            {% endif %}
            {% if deployment_to_sea_event %}
                <tr>
                    <td>{{ deployment_to_sea_event.created_at|date:"n/j/y H:i" }}</td>
                    <td>{{ deployment_to_sea_event.get_action_type_display }}</td>
                    <td>
                        {{ deployment_to_sea_event.detail|safe }}
                    </td>
                    <td>{{ deployment_to_sea_event.user.username }}</td>
                    <td>{{ deployment_to_sea_event.location.name }}</td>
                </tr>
            {% endif %}
            {% if deployment_recovery_event %}
                <tr>
                    <td>{{ deployment_recovery_event.created_at|date:"n/j/y H:i" }}</td>
                    <td>{{ deployment_recovery_event.get_action_type_display }}</td>
                    <td>
                        {{ deployment_recovery_event.detail|safe }}
                    </td>
                    <td>{{ deployment_recovery_event.user.username }}</td>
                    <td>{{ deployment_recovery_event.location.name }}</td>
                </tr>
            {% endif %}
            {% if deployment_retire_event %}
                <tr>
                    <td>{{ deployment_retire_event.created_at|date:"n/j/y H:i" }}</td>
                    <td>{{ deployment_retire_event.get_action_type_display }}</td>
                    <td>
                        {{ deployment_retire_event.detail|safe }}
                    </td>
                    <td>{{ deployment_retire_event.user.username }}</td>
                    <td>{{ deployment_retire_event.location.name }}</td>
                </tr>
            {% endif %}
        </tbody>
  </table>
</div>

{% block javascript %}

<script>
    var containerID = 'deployment-percent-' + {{ deployment_event.id }};
    var deploymentPecentage = {{ deployment_data|get_item:'deployment_percentage' }};
    var timeInField = '{{ deployment_data|get_item:'time_at_sea'|time_at_sea_display }}';
    var deploymentTotalTime = '{{ deployment_event.deployment.get_deployment_time_at_sea|time_at_sea_display }}'

    Highcharts.chart(containerID, {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: 0,
            plotShadow: false,
            spacingBottom: 0,
            spacingTop: 0,
            marginTop: 0,
            marginBottom: 0
        },
        title: {
            text: {{ deployment_data|get_item:'deployment_percentage' }} + '% of <br>Total Deployment',
            align: 'center',
            verticalAlign: 'middle',
            y: 60
        },
        tooltip: {
            formatter: function() { return ' ' +
                this.point.name + '<br />' +
                'Time in Field: ' + this.point.time
            }
        },
        accessibility: {
            point: {
                valueSuffix: '%'
            }
        },
        plotOptions: {
            pie: {
                dataLabels: {
                    enabled: true,
                    distance: -50,
                    style: {
                        fontWeight: 'bold',
                        color: 'white'
                    }
                },
                startAngle: -90,
                endAngle: 90,
                center: ['50%', '75%'],
                size: '110%'
            }
        },
        series: [{
            type: 'pie',
            name: 'Deployment Percentage',
            innerSize: '50%',
            data: [
                {
                    name: 'Item\'s Time On Deployment',
                    y: deploymentPecentage,
                    time: timeInField,
                },
                {
                    name: 'Total Build Deployment',
                    y: 100 - deploymentPecentage,
                    time: deploymentTotalTime,
                },
            ]
        }]
    });
    /*
    Highcharts.chart(containerID, {
        'chart': {
            'type': 'solidgauge'
        },

        'title': null,

        'tooltip': {
            'enabled': false
        },

        'pane': {
          'center': ['50%', '50%'],
          'size': '200px',
          'startAngle': 0,
          'endAngle': 360,
          'background': {
            'backgroundColor': '#EEE',
            'innerRadius': '80%',
            'outerRadius': '100%',
            'borderWidth': 0
          }
        },

        'yAxis': {
          'min': 0,
          'max': 100,
          'labels': {
            'enabled': false
          },

          'lineWidth': 0,
          'minorTickInterval': null,
          'tickPixelInterval': 400,
          'tickWidth': 0
        },

        'plotOptions': {
            'solidgauge': {
                'innerRadius': '80%'
            }
        },

        'series': [{
            'name': 'Speed',
            'data': [80],
            'dataLabels': {
                'enabled': false
            }
        }]
    });
    */

</script>

{% endblock javascript %}
